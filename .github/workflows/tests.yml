name: Test Suite

on: pull_request

jobs:
  build-x86:
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read
    steps:
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v1
        with:
          aws-region: us-west-2
          role-to-assume:  ${{ secrets.ACTIONS_ROLE }}

      - name: Checkout Code
        uses: actions/checkout@v3
        with: 
          submodules: true
          token: ${{ secrets.PAT_GITHUB }}

        
      - name: Update Java
        uses: actions/setup-java@v2
        with: 
          distribution: 'zulu' 
          java-version: '16'
      
      
      - name: Installing pre-requisites
        run: |
          set -x
          # Install some dependencies & premake5
          sudo apt update && sudo apt-get -y install build-essential cmake wget clang g++ libgl1-mesa-dev libvorbis-dev libvpx-dev ninja-build
          wget https://github.com/premake/premake-core/releases/download/v5.0.0-alpha15/premake-5.0.0-alpha15-linux.tar.gz
          tar -xf premake-5.0.0-alpha15-linux.tar.gz
          mkdir bin
          cp premake5 bin/premake5
          sudo chmod a+x premake5
          sudo mv premake5 /usr/local/bin      
      
      - name: Cache NDK
        id: cache
        uses: actions/cache@v3
        with:
          path: |
            ${{github.workspace}}/android-ndk-r22b
          # we are JUST going to cache for this workflow. 
          # really we could cache flutter way more (based on the flutter version)
          key: android-ndk-r22b-linux-x86_64

      - name: Get and Unzip NDK
        if: ${{steps.cache.outputs.cache-hit != 'true'}}
        run: |
          wget https://dl.google.com/android/repository/android-ndk-r22b-linux-x86_64.zip
          unzip android-ndk-r22b-linux-x86_64.zip
          ls

      - name: Build rive for x86
        run: |
          cd cpp && ./build.rive.for.sh -c -a x86 
        env:
          NDK_PATH: ${{github.workspace}}/android-ndk-r22b

    # runs-on: macos-latest
    # steps:
    #   - name: Checkout Code
    #     uses: actions/checkout@v2
        
    #   - name: Update Java
    #     uses: actions/setup-java@v2
    #     with: 
    #       distribution: 'zulu' 
    #       java-version: '16'
      
    #   - name: Build all 
    #     run: |
    #       cd cpp && ./build.all.sh

    #   - name: Test Android v30
    #     uses: reactivecircus/android-emulator-runner@v2
    #     with:
    #       api-level: 30
    #       target: google_apis
    #       script: ./gradlew kotlin:connectedAndroidTest
